apiVersion: v1
kind: ConfigMap
metadata:
  name: kafka-jmx-config
  namespace: kafka-monitoring
data:
  jmx-exporter-config.yml: |
    lowercaseOutputName: true
    lowercaseOutputLabelNames: true
    rules:
    - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)><>Value
      name: kafka_server_$1_$2
      type: GAUGE
      labels:
        clientId: "$3"
        topic: "$4"
        partition: "$5"
    - pattern: kafka.server<type=(.+), name=(.+)><>Value
      name: kafka_server_$1_$2
      type: GAUGE
    - pattern: kafka.(\w+)<type=(.+), name=(.+)><>Value
      name: kafka_$1_$2_$3
      type: GAUGE
---
apiVersion: v1
kind: Service
metadata:
  name: kafka-headless
  namespace: kafka-monitoring
  labels:
    app: kafka
spec:
  ports:
  - port: 9092
    name: plaintext
    targetPort: 9092
  clusterIP: None
  selector:
    app: kafka
---
apiVersion: v1
kind: Service
metadata:
  name: kafka-external
  namespace: kafka-monitoring
  labels:
    app: kafka
spec:
  type: LoadBalancer
  ports:
  - port: 19092
    targetPort: 9092
    name: kafka-0
    nodePort: 31092
  - port: 19093
    targetPort: 9092
    name: kafka-1
    nodePort: 31093
  - port: 19094
    targetPort: 9092
    name: kafka-2
    nodePort: 31094
  selector:
    app: kafka
---
apiVersion: v1
kind: Service
metadata:
  name: kafka-metrics
  namespace: kafka-monitoring
  labels:
    app: kafka
spec:
  type: ClusterIP
  ports:
  - port: 7071
    targetPort: 7071
    protocol: TCP
    name: metrics
  selector:
    app: kafka
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka
  namespace: kafka-monitoring
spec:
  serviceName: kafka-headless
  replicas: 3
  selector:
    matchLabels:
      app: kafka
  template:
    metadata:
      labels:
        app: kafka
    spec:
      initContainers:
      - name: wait-for-zookeeper
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          until nc -z zookeeper-0.zookeeper-headless.kafka-monitoring.svc.cluster.local 2181; do
            echo "Waiting for ZooKeeper..."
            sleep 2
          done
          echo "ZooKeeper is ready"
      
      - name: download-jmx-exporter
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          wget -O /jmx-exporter/jmx_prometheus_javaagent.jar \
          https://repo1.maven.org/maven2/io/prometheus/jmx/jmx_prometheus_javaagent/0.20.0/jmx_prometheus_javaagent-0.20.0.jar
        volumeMounts:
        - name: jmx-exporter
          mountPath: /jmx-exporter
      
      containers:
      - name: kafka
        image: apache/kafka:3.9.0
        command:
        - bash
        - -c
        - |
          set -e
          echo "=========================================="
          echo "Starting Apache Kafka 3.9.0"
          echo "=========================================="

          # Extract broker ID from pod name
          if [[ $HOSTNAME =~ kafka-([0-9]+) ]]; then
            BROKER_ID=${BASH_REMATCH[1]}
          else
            echo "ERROR: Failed to extract broker ID from hostname: $HOSTNAME"
            exit 1
          fi

          echo "Broker ID: $BROKER_ID"

          # Create server.properties
          cat > /tmp/server.properties <<EOF
          # Broker Settings
          broker.id=${BROKER_ID}
          
          # ZooKeeper
          zookeeper.connect=zookeeper-0.zookeeper-headless.kafka-monitoring.svc.cluster.local:2181,zookeeper-1.zookeeper-headless.kafka-monitoring.svc.cluster.local:2181,zookeeper-2.zookeeper-headless.kafka-monitoring.svc.cluster.local:2181
          
          # Listeners
          listeners=PLAINTEXT://:9092
          advertised.listeners=PLAINTEXT://${HOSTNAME}.kafka-headless.kafka-monitoring.svc.cluster.local:9092
          listener.security.protocol.map=PLAINTEXT:PLAINTEXT
          
          # Log Settings
          log.dirs=/var/lib/kafka/data
          num.network.threads=3
          num.io.threads=8
          socket.send.buffer.bytes=102400
          socket.receive.buffer.bytes=102400
          socket.request.max.bytes=104857600
          
          # Replication Settings
          offsets.topic.replication.factor=3
          transaction.state.log.replication.factor=3
          transaction.state.log.min.isr=2
          default.replication.factor=3
          min.insync.replicas=2
          
          # Topic Settings
          auto.create.topics.enable=true
          delete.topic.enable=true
          
          # Log Retention
          log.retention.hours=168
          log.segment.bytes=1073741824
          log.retention.check.interval.ms=300000
          
          # Group Coordinator Settings
          group.initial.rebalance.delay.ms=0
          EOF

          echo ""
          echo "=========================================="
          echo "Kafka Configuration:"
          echo "  Broker ID: $BROKER_ID"
          echo "  Listener: PLAINTEXT://${HOSTNAME}.kafka-headless.kafka-monitoring.svc.cluster.local:9092"
          echo "  JMX Metrics: Port 7071"
          echo "=========================================="
          echo ""

          # Set KAFKA_OPTS for JMX Exporter
          export KAFKA_OPTS="-javaagent:/opt/jmx-exporter/jmx_prometheus_javaagent.jar=7071:/etc/jmx-config/jmx-exporter-config.yml"
          
          # Start Kafka
          exec /opt/kafka/bin/kafka-server-start.sh /tmp/server.properties
        
        ports:
        - containerPort: 9092
          name: plaintext
          protocol: TCP
        - containerPort: 7071
          name: metrics
          protocol: TCP
        
        env:
        - name: KAFKA_HEAP_OPTS
          value: "-Xmx1G -Xms1G"
        
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: "1"
            memory: 2Gi
        
        livenessProbe:
          tcpSocket:
            port: 9092
          initialDelaySeconds: 90
          periodSeconds: 20
          timeoutSeconds: 5
        
        readinessProbe:
          tcpSocket:
            port: 9092
          initialDelaySeconds: 45
          periodSeconds: 10
          timeoutSeconds: 5
        
        volumeMounts:
        - name: data
          mountPath: /var/lib/kafka/data
        - name: jmx-exporter
          mountPath: /opt/jmx-exporter
        - name: jmx-config
          mountPath: /etc/jmx-config
      
      volumes:
      - name: jmx-exporter
        emptyDir: {}
      - name: jmx-config
        configMap:
          name: kafka-jmx-config
  
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
